{% load staticfiles %}
{% load zip %}
<!DOCTYPE html>

<html lang="en">
<head>
  <title>Udghos</title>
<link href='https://fonts.googleapis.com/css?family=Ubuntu' rel='stylesheet' type='text/css'><link href='https://fonts.googleapis.com/css?family=Signika' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Lato">
  <link href='https://fonts.googleapis.com/css?family=Fjord+One' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Gentium+Basic|Raleway' rel='stylesheet' type='text/css'>
  <link href="{% static 'css/styles.css' %}" rel="stylesheet">

  <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
  <link href="{% static 'css/bootstrap.css' %}" rel="stylesheet">

  <link href="{% static 'css/mystatic.css' %}" rel="stylesheet">
    <script src="{% static 'js/functions.js'%}"></script>
    <script>
    function submitPost() {
        var selected = document.getElementsByClassName('selected-tags');
        var tagids =[];
        for(var x=0;x<selected.length;x++) {
            tagids.push(selected[x].getAttribute('id').replace('selected-', ''))
        }
        var inputelem = document.createElement('input');
        inputelem.setAttribute("type", "hidden");
        inputelem.setAttribute("name", "tagids");
        inputelem.setAttribute("value", tagids.toString());
        var form = document.getElementById("thread-form");
        form.appendChild(inputelem);
    }
    </script>

</head>

<body>
  <nav id="navcolor1" class="navbar navbar-inverse navbar-mathi">
      <div class="container">
        <div class="navbar-header">
          <a id="navhead" class="navbar-brand" href="/">Udghos</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul id="headnav" class="nav navbar-nav navbar-right">
            <form class="navbar-form navbar-right" role="search">
              <div class="form-group">
                <div id="search-bar" class="inner-addon right-addon">
                  <i class="glyphicon glyphicon-search"></i>
                  <input type="text" placeholder="Search" class="form-control" />
                </div>
              </div>
              <a href="" class="dropdown-toggle" data-toggle="dropdown">
              <img class="img-navbar" src="{% static 'img/nepal.png' %}" width=30 height=30 /><span class="navbar-name"> <i class="glyphicon glyphicon-triangle-bottom"></i></span></a>
              <ul class="dropdown-menu" role="menu">
                <li><a href="{% url 'profile' %}"><i class="glyphicon glyphicon-user">Profile</i></a></li>
                <li><a href="#"><i class="glyphicon glyphicon-wrench">Settings</i></a></li>
                <li><a href="{% url 'logout' %}"><i class="glyphicon glyphicon-erase">Logout</i></a></li>
              </ul>
            </form>
            </ul>
            <ul id="gly-bell" class="nav navbar-nav navbar-right">
              <li>
                <a href="#" title="Header" data-toggle="popover" data-trigger="focus" data-placement="bottom" data-content="Content">
                <i class="glyphicon glyphicon-bell"></i>
                </a>
              </li>
            </ul>
            
          </ul>
        </div> <!--/.nav-collapse -->
      </div>
  </nav>

  <nav id="navcolor2" class="navbar navbar-inverse navbar-mathi">
    <div class="container">
      <div class="row">
          <div class="col-md-3">
            <a id="navhead" class="navbar-brand" href="/">Udghos</a>
          </div>
            <div class="navmob-header">
              <a class="navbar-mobile-icon glyphicon glyphicon-bell" href="#"></a>
              <a class="navbar-mobile-icon glyphicon glyphicon-search" href="#"></a>
            
              <a href="" class="dropdown-toggle" data-toggle="dropdown">
                  <i class="navbar-mobile-icon glyphicon glyphicon-triangle-bottom"></i></span></a>
                  <ul class="dropdown-menu dropdown-mobile" role="menu">
                    <li><a href="{% url 'profile' %}"><i class="glyphicon glyphicon-user">Profile</i></a></li>
                    <li><a href="#"><i class="glyphicon glyphicon-wrench">Settings</i></a></li>
                    <li><a href="{% url 'logout' %}"><i class="glyphicon glyphicon-erase">Logout</i></a></li>
                  </ul>
            </div>
            
          
    </div>
  </nav>

      <!--div class="navmob-header">
        <a id="navhead" class="navbar-brand" href="/signin/">Udghos</a>
        </div>
            <a class="navbar-icon glyphicon glyphicon-search"></a>
            <a class="navbar-icon glyphicon glyphicon-bell" href="#"></a>

            <a href="" class="navbar-icon dropdown-toggle" data-toggle="dropdown">
              <img class="img-navbar" src="{% static 'img/nepal.png' %}" width=30 height=30 /><span class="navbar-name">User<i class="glyphicon glyphicon-triangle-bottom"></i></span>
              <ul class="dropdown-menu" role="menu">
                <li><a href="/profile/"><i class="glyphicon glyphicon-user">Profile</i></a></li>
                <li><a href="#"><i class="glyphicon glyphicon-wrench">Settings</i></a></li>
                <li><a href="{% url 'logout' %}"><i class="glyphicon glyphicon-logout">Logout</i></a></li>
                </ul>
            </a>
            
      </div>
    </div>
  </nav-->


  <div id="content-top" class="container">
    <div class="row">
      <div class="col-md-9" style="z-index:1">
        <div class="box-pos">
          <div class="row">
            <div class="container">
              <div class="col-md-9 text-center">
                <h1>Nepalâ€™s platform for Change</h1>
                <h3>Post your Complain/Views</h3>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="container">
            <div class="col-md-9 text-center">
              <button type="button" class="btn btn-my btn-large" data-toggle="modal" data-target="#myModal" data-keyboard="true">
              Post a Complain
              </button>
              <!-- Modal -->
              <div class="modal fade" id="myModal" tabindex="-1" aria-labelledby="myModalLabel">
                <div class="modal-dialog" role="document">
                  <div class="modal-content">
                    <div class="modal-header my-color">
                      <button type="button" class="close my-close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                      <h4 class="modal-title my-modal-title" id="myModalLabel">Post Your View</h4><br>
                    </div>
                    <div class="modal-body">
                      <div class="form-group">
                          <label for="recipient-name" class="control-label">Title</label>
                          <input type="text" class="form-control" id="recipient-name" placeholder="Title relevant to the description">
                      </div>
                      <form method="post" id="thread-form" action="{% url 'post' 'thread' %}" onsubmit="return submitPost()" class="form-horizontal" role="form" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input type="hidden" name="thread_type" value="complaint"/>
                        <div class="form-group" style="padding:14px;">
                          <label for="recipient-name" class="control-label">Description *</label>
                          <textarea name="content" class="form-control" placeholder="Your queries here."></textarea>
                          
                          <div class="form">
                            <label for="recipient-name" class="control-label">Tags *</label><br>
                            <input type="text" class="form-control" placeholder="Type in tag names (max 4)" id="tagbox"/>
                            <ul class="nav" id="tags-suggest-list" style="z-index:100;position:absolute;">
                            </ul>
                              <div id="tags-chosen">
                              </div>
                          </div><br><br>
                            <label for="recipient-name" class="control-label">Image(s)</label>
                          <input type="file" name="images" multiple accept="image/*" />
                        </div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                      <button class="btn btn-my" type="submit">Post</button>
                    </div>
                    </form>
                  </div>
                </div>
              </div>     
            </div>
           </div>
          </div>
        </div>

        <div id="tab-stories">
          <div class="box-tabs">
            <ul class="nav nav-tabs" id="navblock" >
              <li class="active"><a data-toggle="tab" href="javascript:void()" onclick="showRecent()">Recent</a></li>
              <li><a data-toggle="tab" href="javascript:void()" onclick="showTop()">Top</a></li>
              <li><a data-toggle="tab" href="javascript:void()" onclick="showFavs()">Favourites</a></li>
            </ul>
          </div>
          <div id="recent-threads">
          </div>
          <div id="top-threads">
          </div>
          <div id="favourite-threads">
          </div>
        </div>
      </div>   
    
      <div id="profile" class="col-md-3">
        <div class="box">
          <img class="img-circle" href="/profile/" src="{% static 'img/nepal.png' %}" width=100 height=100 alt="Generic placeholder image" width="100" height="100">
          <div class="media-body">
            <a href="{% url 'profile' %}">
            <h4>{{user.username}}</h4></a>
            <p>
              <h5 class="heading-property">{{address}}</h5>

              <span class="label label-info">{{threads|length}} Posts</span> 
              <!--a href="#" class="btn btn-xs btn-default"><span class="glyphicon glyphicon-heart"></span>Points</a-->
            </p>
          </div>
          <div class="my-tags">
          <h2 class="heading-property">Top Tags</h2><br>
          <p>#Government</p><p>#Offices</p><p>#Colleges</p><p>#Blocades</p><p>#Road</p>
        </div>
        </div>   
        
      </div>
    </div>  
  </div>

  </body>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="{% static 'js/bootstrap.min.js' %}"></script>
    <script src="{% static 'js/scripts.js' %}"></script>
    <script src="{% static 'js/myjs.js' %}"></script>
    <script src="{% static 'js/homepage.js' %}"></script>

    <script src="https://code.jquery.com/jquery-1.10.2.js"></script>

  <script>
    window.onload = function()  { 
            $('.comment-form').hide();
            //showRecent(); 
            getAndRenderThreads(); 
    };

    var g_thread_container = "recent-threads";
    var g_thread_type = 'recent';
    var g_earliertop = window.scrollY;  // global to check direction of scroll
    var g_tags_selected = [];
    window.onscroll = function() {
        // first get direction of scroll
        var curr = window.scrollY;
        if (curr <= g_earliertop) {
            return;
        }
        g_earliertop = curr;
        var elems = document.getElementsByClassName('box thread');
        var last = elems[elems.length-1];
        var lastid = last.getAttribute('id').replace('thread-','');

        var lastRect = last.getBoundingClientRect();
        var windowH = window.innerHeight;
        console.log(lastRect.top);
        if(lastRect.top <= 0.85*windowH) {
            getAndRenderThreads(g_thread_type, lastid);
        }
    }

    function showTop() {
        g_thread_container = "top-threads";
        g_thread_type = 'top';
        g_earliertop = 0;
        $('#recent-threads').empty();
        $('#favourite-threads').empty();
        getAndRenderThreads('top');
    }

    function showRecent() {
        g_thread_container = "recent-threads";
        g_thread_type = "recent";
        g_earliertop = 0;
        $('#top-threads').empty();
        $('#favourite-threads').empty();
        getAndRenderThreads('recent');
    }
    
    function showFavs() {
    }

    function getAndRenderThreads(type, id) {
        // now get threads from server
        var querystr;
        if (type==undefined) {
            querystr = '?type=recent';
        }
        else {
            querystr = '?type='+type;
        }
        if (id!=undefined)querystr += '&earlierthan='+id;

        $.get('/complain/threads/'+querystr, function(data) {
            for(var x=0;x<data.threads.length;x++) {
                add_item(data.threads[x], g_thread_container);
            }
        });
    }

    function getTags() {
        var query = $('#tagbox').val();
        if (query != '') {
            $.get('/complain/tags?query='+query, function(data) {
                renderTags(data);
            });
        }
    }

    $('#tagbox').on('input', getTags);

    function renderTags(data) {
        var tags = data.tags;
		var ul = document.getElementById('tags-suggest-list');
		ul.innerHTML="";
        for(var x in tags) {
            if (g_tags_selected.indexOf(tags[x].name) < 0 && g_tags_selected.length<4)
			    ul.innerHTML += '<li id="tag-'+tags[x].id+'" onclick="addTag(this)">'+tags[x].name+'</li>';
        }
    }
	
	function addTag(elem) {
        $('#tagbox').val('');
        $('#tags-suggest-list').empty();
        g_tags_selected.push(elem.innerHTML);
        var id = elem.getAttribute('id').replace('tag-', '');
		var tags_elem = document.getElementById('tags-chosen');	
		tags_elem.innerHTML+= '<span id="selected-'+id+'"class="btn selected-tags">' +elem.innerHTML+ '<button type="button" class="close my-close" id="close-tag"><span onclick="removeTag(\''+id+'\''+',\''+elem.innerHTML+'\')" aria-hidden="true">&times;</span></button></span>';
	}

    function removeTag(id, tagname) {
        var index = g_tags_selected.indexOf(tagname);
        g_tags_selected.splice(index, 1);
        $('#selected-'+id).remove();
    } 

  </script>

  </html>
