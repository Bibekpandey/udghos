{% load staticfiles %}
{% load zip %}
<!DOCTYPE html>

<html lang="en">
<head>
  <title>Udghos</title>

  <link rel="icon" type="image/ico" src="/static/img/udghos.ico">
  <link href='https://fonts.googleapis.com/css?family=Ubuntu' rel='stylesheet' type='text/css'><link href='https://fonts.googleapis.com/css?family=Signika' rel='stylesheet' type='text/css'>

  <link href='https://fonts.googleapis.com/css?family=Varela+Round' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Lato">
  
  <link href="{% static 'css/styles.css' %}" rel="stylesheet">

  <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
  <link href="{% static 'css/bootstrap.css' %}" rel="stylesheet">

  <link href="{% static 'css/mystatic.css' %}" rel="stylesheet">
  <link href="{% static 'css/mobile.css' %}" rel="stylesheet">


    <script>
    function submitPost() {
        // first collect tags
        var selected = document.getElementsByClassName('selected-tags');
        var tagids =[];
        for(var x=0;x<selected.length;x++) {
            tagids.push(selected[x].getAttribute('id').replace('selected-', ''))
        }
        // check if title is empty
        var tit = $('input[name=title]').val();
        if(tit.trim() =='') {
            $('#title-warning').show();
            return false;
        }
        // now check if description is empty
        var desc = $('textarea[name=content]').val();
        if (desc.trim() == '') {
            $('#description-warning').show();
            return false;
        }
        if(tagids.length==0) {
            $('#tags-warning').show();
            return false;
        }
        var inputelem = document.createElement('input');
        inputelem.setAttribute("type", "hidden");
        inputelem.setAttribute("name", "tagids");
        inputelem.setAttribute("value", tagids.toString());
        var form = document.getElementById("thread-form");
        form.appendChild(inputelem);
    }
    </script>

    <style>
        .alert-danger {
            background-color:none;
            color:red;
            font-size:0.9em;
        }
    </style>
</head>

<body>
<script>
  function fbs_click() {u="www.udghos.com/haha";t=document.title;window.open('http://www.facebook.com/sharer.php?u='+encodeURIComponent(u)+'&t='+encodeURIComponent(t),'sharer','toolbar=0,status=0,width=626,height=436');return false;}
  </script>
<div id="warning-box" style="position:absolute;top:0px;left:0px;display:none"></div>
  <div id="mask" style="position:absolute;display:none"></div>

  <nav id="navcolor" class="navbar navbar-inverse navbar-mathi">
      <div class="container">
        <div class="navbar-header">
          <a id="navhead" class="navbar-brand" href="/">
            <img class="udghos-logo" src="/static/img/Udghos-logo.png" width="30" height="30">
          </a>
        </div>
        
        {% if authenticated %}
          <ul id="headnav" class="nav navbar-nav navbar-right">
            <a href="" class="dropdown-toggle" data-toggle="dropdown">
              <span class="navbar-name"> <i class="glyphicon glyphicon-triangle-bottom"></i></span>
              <img class="img-navbar" src="/media/{{profile_pic}}" width=30 height=30 /></a>
              <ul class="dropdown-menu" role="menu">
                <li><a href="{% url 'profile' user.id %}">Profile</a></li>
                <li><a href="#">Settings</a></li>
                <li><a href="{% url 'logout' %}">Logout</a></li>
            </ul>
            <form class="navbar-form navbar-right form-group-navbar" role="search" onsubmit="return search()">
              <div class="form-group ">
                <div id="search-bar" class="inner-addon right-addon nav-search">
                  <i class="glyphicon glyphicon-search"></i>
                  <input type="text" id="searchquery" placeholder="Search" class="form-control form-control-navbar" />
                </div>
              </div>
            </form>
            <ul id="gly-bell" class="nav navbar-nav navbar-right">
              <li>
                <a href='#' class='notifications' data-placement="bottom" title="Notifications" >
                <i class="glyphicon glyphicon-bell"></i>
                {% if notifications %}
                <div class="notification-count">
                </div>
                {% endif %}
                </a>
              </li>
            </ul> 
          </ul>
            {% else %}
            
            <ul class="nav navhead-nav nav-unauth">
              <li class="icon-login"><a href="/complain/login" id="click-signup">LogIn/Sign Up</a></li>
              <li class="icon-login"><a href="/about/">About</a></li>
            </ul> 
            {% endif %}        
      </div>
  </nav>

  <div class="container">
    <div id="popover_notification_content" style="display: none">
      <div class="mark-read">
        <a href="javascript:void()" onclick="mark_read()"> Mark as Read</a>
      </div>
      <div class="notification-body">
      {% if notifications %}
      {% else %}
      <div class="single-notification">
        &nbsp; No new notifications
      </div>
      {% endif %}
      {% for notif in notifications %}
        <div class="single-notification">
          <a href="/thread/{{notif.thread}}/">
          <div class="stimg-notification">
                <img class="img-circle" src="/media/{{notif.by_image}}" width=25 height=25/>
          </div>
          {% ifequal notif.type "comment" %}
          Comment on your thread by {{notif.by}}
          {% endifequal %}
          {% ifequal notif.type "support" %}
            Support on your thread by {{notif.by}}
          {% endifequal %}
          {% ifequal notif.type "downvote" %}
            Downvote on your thread by {{notif.by}}
          {% endifequal %}
          </a>
        </div>
    {% endfor %}
      </div>
    </div>
  </div>

  <div id="content-top" >
    <div class="container-fluid">
      <div class="row">
        <div class="box-header">
        <div class="box-image">
          <div class="col-md-3 text-center header-column-first">
            <img class="img-udghos" src="/static/img/Udghos.png" width="300" height="100">

          </div>
          <div class="col-md-6 text-center header-column">
            <h1>Let's make a change</h1>
            <h3>Post your Complain/Views</h3>
            <button type="button" class="btn btn-my btn-large btn-post-desktop" data-toggle="modal" data-target="#myModal" data-keyboard="true">
              Post a Concern
            </button>
            <a href="/complain/post-concern/">
              <button type="button" class="btn btn-my btn-large btn-post-mobile" >
                Post a Concern
              </button>
            </a>
          </div>

          </div>
          <div class="col-md-3 text-center header-column-last">
            <h3>What do you think of Udghos?</h3>
            <button type="button" class="btn btn-sm" data-toggle="modal" data-target="#myModalReview" data-keyboard="true">
              Write a review
            </button>
          </div>

          <div class="container">
            <div class="row">
              <!-- Modal -->
              <div class="modal fade" id="myModal" tabindex="-1" aria-labelledby="myModalLabel">
                <div class="modal-dialog" role="document">
                  <div class="modal-content">
                    <div class="modal-header my-color">
                      <button type="button" class="close my-close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                      <h4 class="modal-title my-modal-title" id="myModalLabel">Post Your View</h4><br>
                    </div>
                    <div class="modal-body">
                      <div class="form-group">
                                                </div>
                      <form method="post" id="thread-form" action="{% url 'post' %}" onsubmit="return submitPost()" class="form-horizontal" role="form" enctype="multipart/form-data">
                          <label for="recipient-name" class="control-label">Title * <small id="title-warning" class="alert-danger" style="display:none"> Please provide a title for the issue!!</small></label>
                          <input name="title" type="text" class="form-control" id="recipient-name" placeholder="Title relevant to the description" oninput="$('#title-warning').hide()">

                        {% csrf_token %}
                        <input type="hidden" name="thread_type" value="complaint"/>
                        <div class="form-group" style="padding:14px;">
                          <label for="recipient-name" class="control-label">Description * <small id="description-warning" class="alert-danger" style="display:none"> Please provide a description of the issue!! </small></label>
                          <textarea name="content" class="form-control" placeholder="Your queries here." oninput="$('#description-warning').hide()"></textarea>
                          
                          <div class="form">
                            <label for="recipient-name" class="control-label">Tags * <small id="tags-warning" class="alert-danger" style="display:none">Please provide at least 1 tag(max 4) </small></label><br>
                            <input type="text" class="form-control" placeholder="Type in tag names (max 4)" id="tagbox"/>
                            <ul class="nav" id="tags-suggest-list" style="z-index:100;position:absolute;">
                            </ul>
                              <div id="tags-chosen">
                              </div>
                          </div><br><br>
                            <label for="recipient-name" class="control-label">Image(s)</label>
                          <input type="file" name="images" multiple accept="image/*" /><br>
                            <input type="checkbox" name="anonymous" value="yes"/><b>Make me Anonymous</b>
                        </div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                      <button class="btn btn-my" type="submit">Post</button>
                    </div>
                    </form>
                  </div>
                </div>
              </div>     
            </div>
           </div>
          </div>

          <div class="container">
            <div class="row">
              <!-- Modal Review-->
              <div class="modal fade" id="myModalReview" tabindex="-1" aria-labelledby="myModalLabel">
                <div class="modal-dialog" role="document">
                  <div class="modal-content">
                    <div class="modal-header my-color">
                      <button type="button" class="close my-close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                      <h4 class="modal-title my-modal-title" id="myModalLabel">Write A Review</h4><br>
                    </div>
                    <div class="modal-body">
                      <div class="form-group">
                          <label for="recipient-name" class="control-label">Do you have anything to share to Udghos. Feel free to Share your Opinion.</label>
                          <input type="text" class="form-control" id="recipient-name" placeholder="Title relevant to your description">
                      </div>
                      <form method="post" id="opinion-form" action="{% url 'post' %}" onsubmit="return false;return submitPost()" class="form-horizontal" role="form" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input type="hidden" name="thread_type" value="complaint"/>
                        <div class="form-group" style="padding:14px;">
                          <label for="recipient-name" class="control-label">Opinion*</label>
                          <textarea name="content-udghos" class="form-control" placeholder="Describe your views on Udghos"></textarea>
                          
                          <div class="form">
                            
                          </div>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                          <button class="btn btn-my" type="submit">Submit</button>
                        </div>
                      </form>
                    </div>
                </div>
              </div>     
            </div>
           </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="row">
      <div class="col-md-0">
        
      </div>
      <div class="col-md-8">
        <div id="tab-stories">
          <div class="box-tabs">

            <div id="error" class="text-center text-danger" style="float:left"> </div>
            <ul class="nav nav-tabs" id="navblock" >
              <li class="active"><a data-toggle="tab" href="javascript:void()" onclick="g_lastId=undefined;showRecent()">Recent</a></li>
              <li><a data-toggle="tab" href="javascript:void()" onclick="g_lastId=undefined;showTop()">Top</a></li>
              <li><a data-toggle="tab" href="javascript:void()" onclick="g_lastId=undefined;showFavs()">Favourites</a></li>
            </ul>

          </div>
          <div id="recent-threads">
          </div>
          <div id="top-threads">
          </div>
          <div id="favourite-threads">
          </div>
        </div>
        <div class="margin-tab">
        </div>
      </div>   

      <div id="profile" class="col-md-4">
        {% if authenticated %}
        <div class="box-profile">
          <img class="img-circle img-homepage" href="{% url 'profile' user.id %}" src="/media/{{profile_pic}}" width=70 height=70 alt="Generic placeholder image" width="100" height="100">
          <div class="media-body">
            <a href="{% url 'profile' user.id %}">
            <h3 class="heading-property user-heading">{{user.username}}</h3></a>
              <h5 class="heading-property">{{address}}</h5>

              <span class="label label-info">{{threads|length}} Posts</span> 
              
            </p>
          </div>
        </div>
        {% endif %}
        <div class="box-tags">
          <span class="heading-property tag-heading">Top Tags</span>
          <a class="top-tags" href="">Nepal</a>
          <a class="top-tags" href="">Education</a>
          <a class="top-tags" href="">Government</a>
        </div>
      </div>   
    </div>      
  </div>

  <div class="box-footer">
    <div class="container" > 
      <footer>
        <div class="footer-body">
          <p class="pull-right">
            <a href="#">Back to top</a>
          </p>
          <p>
            <a href="#">About</a>&middot;
            <a href="#">Privacy</a> &middot; 
            <a href="#">Terms & Conditions</a>
          </p>
          <p class="pull-right">
            <form class="footer-form" role="search">
              <div class="form-group">
                <div id="search-bar" class="inner-addon right-addon nav-search">
                  <i class="glyphicon glyphicon-footer glyphicon-search"></i>
                  <input type="text" placeholder="Search" class="form-control form-control-footer" />
                </div>
              </div>
            </form>
          </p>
          <p class="pull-right">
            <a href="https://facebook.com/udghos">Facebook</a>&middot;
            <a href="https://twitter.com/udghosnepal">Twitter</a>
          </p>
          <p class="copyright">
            &copy; 2016 Udghos, Inc.
          </p>
        </div>
      </footer>
    </div>
  </div>

  </body>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="{% static 'js/bootstrap.min.js' %}"></script>
    <script src="{% static 'js/scripts.js' %}"></script>
    <script src="{% static 'js/myjs.js' %}"></script>
    <script src="{% static 'js/homepage.js' %}"></script>
    <script src="{% static 'js/functions.js'%}"></script>

  <script>
    var g_end_of_posts = false;
    $('#tagbox').on('input', getTags);
    window.onload = function()  { 
        $('html,body').animate({scrollTop:0}, 500);
        $('.comment-form').hide();
        $('#error').text(window.localStorage.getItem("message"));
        window.localStorage.setItem("message","");
        showRecent(); 
    };

    var g_thread_container = "recent-threads";
    var g_thread_type = 'recent';
    var g_earliertop = window.scrollY;  // global to check direction of scroll
    var g_lastId;
    var g_lastVote;

    var g_tags_selected = [];

    window.onscroll = function() {
        // first get direction of scroll
        var curr = window.scrollY;
        if (curr <= g_earliertop) {
            return;
        }
        g_earliertop = curr;
        var elems = document.getElementsByClassName('box thread');
        var last = elems[elems.length-1];

        var lastRect = last.getBoundingClientRect();
        var windowH = window.innerHeight;
        if(lastRect.top <= 0.85*windowH) {
            if(g_lastId==null) return;
            var data = {earlierthan:g_lastId.toString(),
                lessthan:g_lastVote.toString()};
            g_lastId = null;
            getAndRenderThreads(g_thread_type, data);
        }
    }

    function showTop() {
	g_end_of_posts = false;
        g_thread_container = "top-threads";
        g_thread_type = 'top';
        g_earliertop = 0;
        $('#recent-threads').empty();
        $('#favourite-threads').empty();
        var query='';
        if (g_lastId != undefined && g_lastVote != undefined) {
            query = 'earlierthan='+g_lastId.toString()+'&';
            query += 'lessthan='+g_lastVote.toString();
        }
        getAndRenderThreads('top', query);
    }

    function showRecent() {
	g_end_of_posts = false;
        g_thread_container = "recent-threads";
        g_thread_type = "recent";
        g_earliertop = 0;
        $('#top-threads').empty();
        $('#favourite-threads').empty();
        var query='';
        if (g_lastId != undefined)
            query = 'earlierthan='+g_lastId.toString();
        else query = '';
        getAndRenderThreads('recent', query);
    }
    

    function showFavs() {
	g_end_of_posts = false;
        g_thread_container = "favourite-threads";
        g_thread_type = "favourite";
        g_earliertop = 0;
        $('#top-threads').empty();
        $('#recent-threads').empty();
        var query='';
        if (g_lastId != undefined)
            query = 'earlierthan='+g_lastId.toString();
        else query = '';
        getAndRenderThreads('favourite', query);

    }

    function getAndRenderThreads(type, data) {
        // now get threads from server
        if (g_end_of_posts) {
            return;
        }

        $.get('/complain/threads/'+type, data, function(data) {
            g_lastId = data.lastid;
            if(g_lastId==null) g_end_of_posts = true;
            g_lastVote = data.lastvote;
            if(data.end==true) {
                g_end_of_posts=true;
            }
            for(var x=0;x<data.threads.length;x++) {
                add_item(data.threads[x], g_thread_container, data.authenticated);
            }
        });
    }
function getTags() {
        var query = $('#tagbox').val();
        if (query != '') {
            $.get('/complain/tags?query='+query, function(data) {
                renderTags(data);
            });
        }
    }

    function renderTags(data) {
        var tags = data.tags;
		var ul = document.getElementById('tags-suggest-list');
		ul.innerHTML="";
        for(var x in tags) {
            if (g_tags_selected.indexOf(tags[x].name) < 0 && g_tags_selected.length<4)
			    ul.innerHTML += '<li id="tag-'+tags[x].id+'" onclick="addTag(this)">'+tags[x].name+'</li>';
        }
    }
	
	function addTag(elem) {
        $('#tags-warning').hide();
        $('#tagbox').val('');
        $('#tags-suggest-list').empty();
        g_tags_selected.push(elem.innerHTML);
        var id = elem.getAttribute('id').replace('tag-', '');
		var tags_elem = document.getElementById('tags-chosen');	
		tags_elem.innerHTML+= '<span id="selected-'+id+'"class="btn selected-tags">' +elem.innerHTML+ '<button type="button" class="close my-close" id="close-tag"><span onclick="removeTag(\''+id+'\''+',\''+elem.innerHTML+'\')" aria-hidden="true">&times;</span></button></span>';
	}

    function removeTag(id, tagname) {
        var index = g_tags_selected.indexOf(tagname);
        g_tags_selected.splice(index, 1);
        $('#selected-'+id).remove();
    }


  </script>

  </html>
